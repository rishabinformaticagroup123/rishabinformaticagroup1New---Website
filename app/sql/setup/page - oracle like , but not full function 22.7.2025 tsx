'use client';

import { useEffect, useState } from 'react';
import AceEditor from 'react-ace';
import Split from 'react-split';
import 'ace-builds/src-noconflict/mode-sql';
import 'ace-builds/src-noconflict/theme-chrome';
import 'ace-builds/src-noconflict/theme-tomorrow';
import 'ace-builds/src-noconflict/ext-language_tools';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import classNames from 'classnames';

const oracleSample = `SELECT EMPLOYEE_ID, FIRST_NAME, SALARY FROM EMPLOYEES WHERE ROWNUM <= 5;`;

const convertOracleToPostgreSQL = (query: string): string => {
  return query
    .replace(/NVL/gi, 'COALESCE')
    .replace(/SYSDATE/gi, 'CURRENT_DATE')
    .replace(/TO_DATE\(([^)]+)\)/gi, 'CAST($1 AS DATE)')
    .replace(/DUAL/gi, '')
    .replace(/ROWNUM <= (\d+)/gi, 'LIMIT $1')
    .replace(/NUMBER/gi, 'NUMERIC')
    .replace(/VARCHAR2/gi, 'VARCHAR')
    .replace(/SYSTIMESTAMP/gi, 'CURRENT_TIMESTAMP')
    .replace(/TO_CHAR\(([^)]+)\)/gi, 'CAST($1 AS TEXT)')
    .replace(/FROM\s+\(/gi, 'FROM (SELECT') // basic subquery fix
    .replace(/;$/, '');
};

export default function Page() {
  const [sqlInput, setSqlInput] = useState(oracleSample);
  const [result, setResult] = useState<any[]>([]);
  const [isOracleMode, setIsOracleMode] = useState(true);

  const handleRun = async () => {
    const finalQuery = isOracleMode ? sqlInput : convertOracleToPostgreSQL(sqlInput);
    try {
      const response = await fetch('/api/sql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: finalQuery }),
      });
      const data = await response.json();
      setResult(data);
    } catch (error) {
      console.error('Error executing SQL:', error);
      setResult([]);
    }
  };

  const toggleMode = () => {
    setIsOracleMode(!isOracleMode);
  };

  return (
    <div className="p-4 bg-[#f2f2f2] min-h-screen">
      <div className="flex justify-between items-center mb-2">
        <h1 className="text-xl font-bold text-orange-700">SQL Query Editor</h1>
        <div className="flex gap-2">
          <Button onClick={toggleMode} className="bg-orange-600 hover:bg-orange-700 text-white">
            {isOracleMode ? 'Switch to PostgreSQL' : 'Switch to Oracle'}
          </Button>
          <Button onClick={handleRun} className="bg-green-600 hover:bg-green-700 text-white">
            Run Query
          </Button>
        </div>
      </div>

      <Card className="mb-3">
        <CardContent className="p-2 border rounded">
          <AceEditor
            mode="sql"
            theme={isOracleMode ? 'chrome' : 'tomorrow'}
            value={sqlInput}
            onChange={setSqlInput}
            name="sql_editor"
            fontSize={14}
            showPrintMargin
            showGutter
            highlightActiveLine
            width="100%"
            height="180px"
            setOptions={{
              enableBasicAutocompletion: true,
              enableLiveAutocompletion: true,
              showLineNumbers: true,
              tabSize: 2,
            }}
          />
        </CardContent>
      </Card>

      <div className="grid grid-cols-4 gap-2">
        <div className="bg-white p-2 rounded shadow col-span-1">
          <h2 className="font-semibold text-orange-700 mb-2">Tables</h2>
          <ul className="text-sm text-gray-800">
            <li>EMPLOYEES</li>
            <li>DEPARTMENTS</li>
            <li>JOBS</li>
            <li>LOCATIONS</li>
            <li>COUNTRIES</li>
          </ul>
        </div>

        <div className="col-span-3">
          {result.length > 0 && (
            <div className="overflow-x-auto bg-white p-2 rounded shadow">
              <table className="w-full border-collapse border border-gray-300 text-sm">
                <thead className="bg-gray-100">
                  <tr>
                    {Object.keys(result[0]).map((col) => (
                      <th key={col} className="border px-3 py-1 text-left font-semibold">
                        {col}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {result.map((row, rowIndex) => (
                    <tr key={rowIndex} className="odd:bg-white even:bg-gray-50">
                      {Object.values(row).map((value, colIndex) => (
                        <td key={colIndex} className="border px-3 py-1">
                          {value as string}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
